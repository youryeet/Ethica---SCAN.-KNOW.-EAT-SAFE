import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";
import vision from "@google-cloud/vision";
import fetch from "node-fetch";

dotenv.config();

const app = express();

// ----------------- CORS CONFIG -----------------
app.use(
  cors({
    origin: ["http://127.0.0.1:5501", "http://localhost:5501"],
    methods: ["GET", "POST", "OPTIONS"],
    allowedHeaders: ["Content-Type", "Authorization"],
    credentials: true,
  })
);

// ----------------- JSON PARSING -----------------
app.use(express.json({ limit: "10mb" }));

// ----------------- OPENAI & GOOGLE VISION SETUP -----------------
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const client = new vision.ImageAnnotatorClient();

// ----------------- OCR FUNCTION -----------------
async function extractTextFromImage(base64Image) {
  const [result] = await client.textDetection({ image: { content: base64Image } });
  const detections = result.textAnnotations;
  if (!detections || detections.length === 0) return "";
  return detections[0].description;
}

// ----------------- OCR + EXTRACT INGREDIENTS -----------------
app.post("/extract-ingredients", async (req, res) => {
  const { imageBase64 } = req.body;
  if (!imageBase64) return res.status(400).json({ error: "No image provided" });

  try {
    const text = await extractTextFromImage(imageBase64);
    if (!text || text.trim() === "")
      return res.status(400).json({ error: "No text found in image" });

    const response = await openai.chat.completions.create({
      model: "gpt-5-mini",
      messages: [
        {
          role: "system",
          content:
            "You are an expert at extracting ingredients from product labels. Always translate the text into English and return only the ingredient names, as a comma-separated list, lowercase, no extra text.",
        },
        { role: "user", content: `Here is the product text:\n\n"${text}"` },
      ],
      temperature: 0,
    });

    const ingredientsRaw = response.choices[0].message.content.trim();
    const ingredients = ingredientsRaw
      .split(",")
      .map((i) => i.trim())
      .filter((i) => i.length > 0);

    res.json({ ingredients });
  } catch (err) {
    console.error("OCR/OpenAI error:", err);
    res.status(500).json({ error: "Failed to extract ingredients" });
  }
});

// ----------------- FREE OCR ENDPOINT -----------------
app.post("/ocr", async (req, res) => {
  try {
    const { imageBase64 } = req.body;
    if (!imageBase64) return res.status(400).json({ error: "No image provided" });

    const text = await extractTextFromImage(imageBase64);
    res.json({ text });
  } catch (err) {
    console.error("OCR error:", err);
    res.status(500).json({ error: "OCR failed" });
  }
});

// ----------------- FREE TRANSLATION ENDPOINT -----------------
app.post("/translate", async (req, res) => {
  try {
    const { text, targetLang } = req.body;
    if (!text || !targetLang)
      return res.status(400).json({ error: "Missing parameters" });

    const response = await fetch("https://libretranslate.com/translate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        q: text,
        source: "auto",
        target: targetLang,
        format: "text",
      }),
    });

    const data = await response.json();
    res.json({ translatedText: data.translatedText });
  } catch (err) {
    console.error("Translation error:", err);
    res.status(500).json({ error: "Translation failed" });
  }
});

// ----------------- TEST CORS ENDPOINT -----------------
app.get("/test-cors", (req, res) => {
  res.json({ message: "âœ… CORS is working!" });
});

// ----------------- START SERVER -----------------
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
