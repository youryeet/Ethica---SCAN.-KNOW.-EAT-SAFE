<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <title>Ethica ‚Äì SCAN. KNOW. EAT SAFE. </title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }

    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      color: #333;
      background: #f8faf9;
      font-family: "Poppins", sans-serif;
    }

    #sustainabilityResult {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 1.5rem;
      margin-top: 1.5rem;
      display: inline-block;
      border: 1px solid #e8e8e8;
    }

    #sustainabilityText {
      font-weight: 600;
      margin-top: 12px;
      font-size: 18px;
    }

    .app-container {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 2px 20px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
      text-align: center;
      animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      color: #2d5f3f;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      animation: slideDown 0.6s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h3 {
      color: #666;
      font-weight: 500;
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
    }

    .scan-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    /* Clean, modern scan buttons */
    .scan-btn {
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 0.8rem;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
    }

    .scan-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .scan-btn:active {
      transform: translateY(0);
    }

    input[type="file"] {
      display: none;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.8rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 0.5rem;
    }

    button:hover {
      background-color: #45a049;
      transform: translateY(-1px);
    }

    #cameraModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    #cameraModal.active {
      display: flex;
    }

    .camera-container {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: zoomIn 0.3s ease;
    }

    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
      }
    }

    #cameraTitle {
      color: #4CAF50;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    #cameraFeed {
      width: 100%;
      max-width: 500px;
      border-radius: 1rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .camera-controls {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .camera-controls button {
      padding: 0.8rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .camera-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #captureBtn {
      background: linear-gradient(135deg, #4CAF50 0%, #00BFA6 100%);
      color: white;
    }

    #ocrText {
      margin-top: 15px;
      font-style: italic;
      color: #555;
    }

    #results {
      margin-top: 25px;
      text-align: center;
      background: #eaf5eb;
      border-radius: 1rem;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      word-wrap: break-word;
    }

    #results h2 {
      color: #4CAF50;
      margin-top: 0;
    }

    #results p {
      margin: 0.5rem 0;
    }

    .footer {
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #777;
      text-align: center;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-top: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-container {
      width: 100%;
      background: #f0f0f0;
      border-radius: 50px;
      overflow: hidden;
      margin: 20px 0;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
      height: 30px;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #00BFA6);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
      border-radius: 50px;
      box-shadow: 0 2px 10px rgba(76, 175, 80, 0.4);
    }

    .loading-message {
      margin-top: 10px;
      font-size: 14px;
      color: #4CAF50;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin: 1.5rem auto;
      width: 90%;
      max-width: 450px;
      text-align: center;
      animation: fadeInUp 0.6s ease forwards;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .result-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    #allergenResult {
      font-size: 1.2rem;
      font-weight: 600;
      padding: 1.5rem;
      border-radius: 1rem;
      margin: 1.5rem 0;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      animation: fadeInScale 0.5s ease;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #allergenResult.green { 
      background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
      color: #2E7D32; 
      border: 2px solid #4CAF50;
    }
    
    #allergenResult.yellow { 
      background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%);
      color: #F57F17; 
      border: 2px solid #FBC02D;
    }
    
    #allergenResult.red { 
      background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
      color: #C62828; 
      border: 2px solid #E53935;
    }

    .caution-details {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      text-align: left;
      padding-left: 1rem;
    }

    .caution-details ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .caution-details li {
      margin: 0.3rem 0;
    }

    .bar-container { margin-top: 10px; display:flex; flex-direction:column; gap:0.9rem; }
    .bar { 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 50px;
      overflow: hidden;
      height: 35px;
      position: relative;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .bar span { 
      position: absolute;
      left: 15px;
      top: 8px;
      font-size: 14px;
      color: #2f2f2f;
      font-weight: 700;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }
    
    .bar-fill { 
      height: 100%;
      border-radius: 50px;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    #co2Bar { background: linear-gradient(90deg, #66bb6a, #43a047); }
    #waterBar { background: linear-gradient(90deg, #42a5f5, #1e88e5); }
    #animalBar { background: linear-gradient(90deg, #ffa726, #fb8c00); }

    .chart-card { background:white; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin-top:12px; }

    #insightText { 
      background: linear-gradient(135deg, #FFD54F 0%, #FFC107 100%);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 5px 20px rgba(255, 213, 79, 0.3);
      font-size: 0.95rem;
      line-height: 1.6;
    }

    #insightText strong {
      color: #E65100;
      font-size: 1.1rem;
    }

    canvas#barcodeCanvas { 
      display: none; 
      max-width: 100%; 
      border: 3px solid #4CAF50; 
      margin-top: 15px;
      border-radius: 1rem;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    .barcode-mode canvas#barcodeCanvas { 
      display: block;
      animation: fadeInScale 0.3s ease-out;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .scan-options {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .scan-btn {
        padding: 1.2rem 2rem;
      }
      
      .camera-container {
        padding: 1.5rem;
      }
    }
    
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }
      
      h3 {
        font-size: 1rem;
      }
      
      .scan-btn {
        font-size: 1rem;
        padding: 1rem 1.5rem;
      }
    }
  </style>
</head>
<body>

  <div class="app-container">
    <h1>Ethica</h1>
    <h3>SCAN. KNOW. EAT SAFE ‚Äì Scan Ingredients</h3>
    
    <button onclick="window.location.href='index.html'" style="background:#00BFA6; padding:0.6rem 1.2rem; font-size:0.85rem; margin-bottom:1rem;">
      ‚öôÔ∏è Edit Preferences
    </button>
    
    <p>Choose how you want to scan your product:</p>
    
    <div class="scan-options">
      <button class="scan-btn barcode" onclick="openBarcodeScanner()">üì∑ Scan Barcode</button>
      <button class="scan-btn" onclick="openCamera()">üì∏ Take Photo</button>
      <button class="scan-btn" onclick="document.getElementById('imageInput').click()">üìÅ Upload Image</button>
    </div>

    <input type="file" id="imageInput" accept="image/*" onchange="handleFileUpload()">

    <!-- Progress Bar -->
    <div id="progressContainer" class="progress-container" style="display: none;">
      <div id="progressBar" class="progress-bar-fill">0%</div>
    </div>
    <div id="loadingMessage" class="loading-message" style="display: none;"></div>

    <p id="ocrText"></p>
    <div id="allergenResult" style="text-align:center; font-size:24px; font-weight:bold; margin-bottom:15px;"></div>

    <div id="results"></div>
    <br>

    <div id="sustainabilityResult" class="result-card">
      <h2>üå± Sustainability Breakdown</h2>

      <div class="bar-container" style="margin-top: 8px;">
        <div class="bar">
          <span>CO‚ÇÇ Impact</span>
          <div class="bar-fill" id="co2Bar"></div>
        </div>
        <div class="bar">
          <span>Water Usage</span>
          <div class="bar-fill" id="waterBar"></div>
        </div>
        <div class="bar">
          <span>Animal Impact</span>
          <div class="bar-fill" id="animalBar"></div>
        </div>
      </div>

      <div id="sustainabilityText" style="margin-top: 12px; font-weight: 700; font-size: 1.1rem;"></div>

      <div class="chart-card" style="margin-top: 18px;">
        <canvas id="comparisonChart" width="400" height="200"></canvas>
      </div>

      <div id="insightText" style="margin-top: 12px; font-size: 0.95rem; color: #333;"></div>
    </div>

    <div class="footer">Guided by Ahimsa üíö</div>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal">
    <div id="cameraContainer" class="camera-container">
      <h2 id="cameraTitle">Camera Capture</h2>
      <div id="videoWrapper" style="position:relative;">
        <video id="cameraFeed" autoplay playsinline></video>
        <canvas id="barcodeCanvas"></canvas>
        <!-- Barcode Guide Box -->
        <div id="barcodeGuide" style="display:none; position:absolute; top:25%; left:15%; right:15%; bottom:25%; border:3px dashed #4CAF50; border-radius:10px; pointer-events:none; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);">
          <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(76,175,80,0.9); color:white; padding:0.5rem 1rem; border-radius:0.5rem; font-size:0.9rem; white-space:nowrap;">
            üì± Center barcode here
          </div>
        </div>
      </div>
      <div class="camera-controls">
        <button id="captureBtn" onclick="capturePhoto()">üì∏ Capture</button>
        <button onclick="closeCamera()" style="background:#e53e3e;">‚úñ Cancel</button>
      </div>
      <p id="barcodeResult" style="margin-top:10px; color:#4CAF50; font-weight:bold;"></p>
    </div>
  </div>

  <script>
    const userAllergens = JSON.parse(localStorage.getItem('userAllergens')) || {};
    console.log("User allergens from localStorage:", userAllergens);

    let cameraStream = null;
    let barcodeInterval = null;
    let isBarcodeMode = false;
    let selectedDiets = [];
    let selectedAllergens = [];
    let customDiets = [];
    let customAllergens = [];

    // Load dietary preferences and allergens from localStorage (set in index.html)
    function loadPreferences() {
      const savedDiets = localStorage.getItem('ethica_diets');
      const savedAllergens = localStorage.getItem('ethica_allergens');
      const savedCustomDiets = localStorage.getItem('ethica_custom_diets');
      const savedCustomAllergens = localStorage.getItem('ethica_custom_allergens');

      if (savedDiets) selectedDiets = JSON.parse(savedDiets);
      if (savedAllergens) selectedAllergens = JSON.parse(savedAllergens);
      if (savedCustomDiets) customDiets = JSON.parse(savedCustomDiets);
      if (savedCustomAllergens) customAllergens = JSON.parse(savedCustomAllergens);

      // Combine standard and custom for analysis
      const allDiets = [...selectedDiets, ...customDiets];
      const allAllergens = [...selectedAllergens, ...customAllergens];

      console.log('Loaded preferences - Diets:', allDiets, 'Allergens:', allAllergens);
    }

    // Call on page load
    document.addEventListener('DOMContentLoaded', loadPreferences);

    // CAMERA FUNCTIONS
    async function openCamera() {
      isBarcodeMode = false;
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('cameraFeed');
      
      // Update UI for photo capture mode
      isBarcodeMode = false;
      document.getElementById('cameraTitle').textContent = 'Camera Capture';
      document.getElementById('captureBtn').style.display = 'inline-block';
      document.getElementById('cameraContainer').classList.remove('barcode-mode');
      document.getElementById('barcodeResult').textContent = '';
      
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        video.srcObject = cameraStream;
        modal.classList.add('active');
      } catch (err) {
        alert('Camera access denied or unavailable');
        console.error(err);
      }
    }

    function closeCamera() {
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('cameraFeed');
      
      // Stop Quagga if in barcode mode
      if (isBarcodeMode && window.Quagga) {
        Quagga.stop();
        Quagga.offDetected();
      }
      
      if (cameraStream) {
        if (typeof cameraStream === 'string') {
          // Quagga stream reference - already stopped above
          cameraStream = null;
        } else {
          // Regular MediaStream
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
        }
      }
      
      if (barcodeInterval) {
        clearInterval(barcodeInterval);
        barcodeInterval = null;
      }
      
      video.srcObject = null;
      modal.classList.remove('active');
      document.getElementById('barcodeResult').textContent = '';
      document.getElementById('barcodeGuide').style.display = 'none';
      
      // Reset barcode mode
      isBarcodeMode = false;
      document.getElementById('cameraContainer').classList.remove('barcode-mode');
    }

    async function capturePhoto() {
      const video = document.getElementById('cameraFeed');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      closeCamera();
      
      canvas.toBlob(blob => {
        processImage(blob);
      }, 'image/jpeg');
    }

    // BARCODE SCANNER
    async function openBarcodeScanner() {
      isBarcodeMode = true;
      console.log('openBarcodeScanner called - using Quagga');
      
      const modal = document.getElementById('cameraModal');
      const videoWrapper = document.getElementById('videoWrapper');
      const video = document.getElementById('cameraFeed');
      const canvas = document.getElementById('barcodeCanvas');
      const resultText = document.getElementById('barcodeResult');
      
      // Update UI for barcode scanning mode
      document.getElementById('cameraTitle').textContent = 'Barcode Scanner';
      document.getElementById('captureBtn').style.display = 'none';
      document.getElementById('cameraContainer').classList.add('barcode-mode');
      document.getElementById('barcodeGuide').style.display = 'block';
      
      if (!window.Quagga) {
        alert('Barcode scanner library not loaded. Please refresh the page.');
        return;
      }
      
      try {
        resultText.innerHTML = `
          <div style="text-align:left; background:#f5f5f5; padding:1rem; border-radius:0.5rem;">
            <strong style="color:#4CAF50;">ÔøΩ Starting camera...</strong><br>
            <div style="font-size:0.85rem; color:#666; margin-top:0.5rem;">
              <strong>Tips for best scanning:</strong><br>
              ‚Ä¢ Hold phone steady<br>
              ‚Ä¢ Ensure good lighting<br>
              ‚Ä¢ Center barcode in green box<br>
              ‚Ä¢ Keep barcode flat & clear
            </div>
          </div>
        `;
        modal.classList.add('active');
        
        // Check camera availability
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Camera not supported on this device');
        }
        
        // Initialize Quagga with enhanced settings
        Quagga.init({
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: videoWrapper,  // Use wrapper div instead of video element directly
            constraints: {
              facingMode: "environment",
              width: { ideal: 1920 },
              height: { ideal: 1080 },
              aspectRatio: { ideal: 16/9 }
            },
            area: { // Scanning area - center focus
              top: "25%",
              right: "15%",
              left: "15%",
              bottom: "25%"
            }
          },
          decoder: {
            readers: [
              "ean_reader",      // EAN-13, EAN-8 (most common worldwide)
              "ean_8_reader",
              "upc_reader",      // UPC-A, UPC-E (US/Canada)
              "upc_e_reader",
              "code_128_reader", // Code 128
              "code_39_reader",  // Code 39
              "code_39_vin_reader",
              "codabar_reader",
              "i2of5_reader"
            ],
            debug: {
              drawBoundingBox: true,
              showFrequency: false,
              drawScanline: true,
              showPattern: false
            },
            multiple: false
          },
          locate: true,
          locator: {
            halfSample: true,
            patchSize: "medium",
            debug: {
              showCanvas: false,
              showPatches: false,
              showFoundPatches: false,
              showSkeleton: false,
              showLabels: false,
              showPatchLabels: false,
              showRemainingPatchLabels: false,
              boxFromPatches: {
                showTransformed: false,
                showTransformedBox: false,
                showBB: false
              }
            }
          },
          frequency: 10,
          numOfWorkers: navigator.hardwareConcurrency || 4,
          locate: true
        }, function(err) {
          if (err) {
            console.error('Quagga init error:', err);
            
            // Provide helpful error messages
            let errorMsg = 'Camera initialization failed';
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
              errorMsg = 'üì∏ Camera permission denied.\n\nPlease:\n1. Click the camera icon in your browser address bar\n2. Allow camera access for this site\n3. Reload the page';
            } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
              errorMsg = 'No camera found on this device';
            } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
              errorMsg = 'Camera is already in use by another application';
            } else if (err.message) {
              errorMsg = 'Camera error: ' + err.message;
            }
            
            resultText.textContent = '‚ùå ' + errorMsg;
            alert(errorMsg);
            closeCamera();
            return;
          }
          
          console.log("Quagga initialization finished. Ready to start");
          resultText.textContent = 'üîç Scanning for barcode... Hold steady!';
          Quagga.start();
          
          // Store stream reference
          cameraStream = Quagga.CameraAccess.getActiveStreamLabel();
        });
        
        // Handle detected barcodes with confidence checking
        Quagga.onDetected(function(result) {
          // Only accept high-confidence reads
          if (!result || !result.codeResult || !result.codeResult.code) {
            return;
          }
          
          const code = result.codeResult.code;
          const confidence = result.codeResult.decodedCodes
            .filter(code => code.error !== undefined)
            .reduce((sum, code) => sum + (1 - code.error), 0) / result.codeResult.decodedCodes.length;
          
          console.log(`Barcode detected: ${code}, Confidence: ${(confidence * 100).toFixed(1)}%`);
          
          // Require at least 70% confidence
          if (confidence < 0.7) {
            console.log('Low confidence, continuing scan...');
            return;
          }
          
          console.log('‚úÖ High confidence barcode detected:', code);
          
          resultText.textContent = `‚úÖ Found: ${code}`;
          resultText.style.color = '#4CAF50';
          
          // Vibrate if available
          if (navigator.vibrate) {
            navigator.vibrate(200);
          }
          
          // Stop Quagga and process barcode
          Quagga.stop();
          Quagga.offDetected();
          
          setTimeout(() => {
            closeCamera();
            fetchProductFromBarcode(code);
          }, 500);
        });
        
      } catch (err) {
        alert('Camera error: ' + err.message);
        console.error('Camera access error:', err);
        resultText.textContent = '‚ùå Camera access denied';
      }
    }

    // PROCESS BARCODED INGREDIENTS (skip OCR, go straight to parsing)
    async function processBarcodedIngredients(ingredientsText) {
      updateProgress(40, 'Parsing ingredients from barcode...');
      
      try {
        // Clean and parse ingredients text
        const cleanedText = ingredientsText.toLowerCase().trim();
        
        // Split by common delimiters
        const ingredients = cleanedText
          .split(/[,;]+/)
          .map(ing => ing.trim())
          .filter(ing => ing.length > 2)
          .map(ing => {
            // Remove percentages and extra info in parentheses
            return ing.replace(/\([^)]*\)/g, '').replace(/\d+%/g, '').trim();
          })
          .filter(ing => ing.length > 0);
        
        if (ingredients.length > 0) {
          await analyzeIngredients(ingredients);
        } else {
          hideProgress();
          alert('Could not parse ingredients from barcode. Please scan the label directly.');
        }
        
      } catch (err) {
        console.error('Ingredient parsing error:', err);
        hideProgress();
        alert('Error parsing ingredients. Please try scanning the label directly.');
      }
    }

    // BARCODE LOOKUP
    async function fetchProductFromBarcode(barcode) {
      updateProgress(20, 'Looking up product from barcode...');
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        let response;
        try {
          // Try OpenFoodFacts first (largest database)
          response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}`, {
            signal: controller.signal
          });
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === 'AbortError') {
            throw new Error('Barcode lookup timed out');
          } else if (!navigator.onLine) {
            throw new Error('No internet connection');
          } else {
            throw new Error(`Network error: ${fetchError.message}`);
          }
        }
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`Barcode lookup failed (${response.status})`);
        }
        
        const data = await response.json();
        
        if (data.status === 1 && data.product) {
          const product = data.product;
          const ingredientsText = product.ingredients_text || product.ingredients_text_en || '';
          
          if (!ingredientsText) {
            hideProgress();
            closeCamera(); // Close the barcode scanner
            alert(`‚úÖ Product found: ${product.product_name || 'Unknown'}\n${product.brands ? 'Brand: ' + product.brands : ''}\n\n‚ö†Ô∏è Ingredients not available in database.\n\nThe OpenFoodFacts database has this product but the ingredient list hasn't been added yet.\n\nüëâ Solution: Use the "Take Picture" or "Upload File" option to scan the ingredients label directly.`);
            return;
          }
          
          document.getElementById('ocrText').innerHTML = `‚úÖ Product: ${product.product_name || 'Unknown'}<br>Brand: ${product.brands || 'Unknown'}`;
          
          // Parse ingredients directly (skip OCR since we have text)
          processBarcodedIngredients(ingredientsText);
          
        } else {
          alert(`‚ö†Ô∏è Product not found in database.\n\nBarcode: ${barcode}\n\nThis could mean:\n‚Ä¢ Product is not yet in OpenFoodFacts database\n‚Ä¢ Barcode is region-specific\n‚Ä¢ Product is new/uncommon\n\nPlease scan the ingredients label directly using the photo option.`);
          hideProgress();
        }
      } catch (err) {
        console.error('Barcode lookup error:', err);
        let errorMsg = 'Failed to look up barcode.';
        
        if (err.message.includes('No internet')) {
          errorMsg = '‚ùå No internet connection.\n\nPlease check your network and try again.';
        } else if (err.message.includes('timed out')) {
          errorMsg = '‚è±Ô∏è Barcode lookup timed out.\n\nPlease try again or scan the ingredients label directly.';
        }
        
        alert(errorMsg + '\n\nYou can still scan the ingredients label using the photo option.');
        hideProgress();
      }
    }

    // FILE UPLOAD HANDLER
    function handleFileUpload() {
      const file = document.getElementById('imageInput').files[0];
      if (file) {
        processImage(file);
      }
    }

    // UNIFIED IMAGE PROCESSING
    async function processImage(imageFile) {
      const ocrTextElement = document.getElementById("ocrText");
      ocrTextElement.innerHTML = '';
      updateProgress(10, 'Uploading image...');

      try {
        const reader = new FileReader();
        const base64Image = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result.split(",")[1]);
          reader.onerror = reject;
          reader.readAsDataURL(imageFile);
        });

        updateProgress(20, 'Extracting ingredients from image...');
        
        const ingredientsResponse = await fetch("https://ethica-backend-830766747753.us-central1.run.app/extract-ingredients", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageBase64: base64Image })
        });

        if (!ingredientsResponse.ok) throw new Error(`Server returned ${ingredientsResponse.status}`);
        
        const ingredientsData = await ingredientsResponse.json();
        
        if (!ingredientsData.ingredients || ingredientsData.ingredients.length === 0) {
          hideProgress();
          ocrTextElement.innerText = "‚úÖ OCR succeeded, but no known ingredients were detected.";
          return;
        }

        const ingredients = ingredientsData.ingredients;
        await analyzeIngredients(ingredients);

      } catch(err) {
        console.error("‚ùå Error:", err);
        hideProgress();
        ocrTextElement.innerHTML = `‚ùå Error: ${err.message}`;
      }
    }

    // PROCESS INGREDIENTS TEXT (from barcode lookup)
    async function processIngredientsText(text) {
      updateProgress(30, 'Processing ingredients...');
      
      try {
        // Send to backend to parse ingredients
        const response = await fetch("https://ethica-backend-830766747753.us-central1.run.app/extract-ingredients", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            imageBase64: btoa(text)
          })
        });

        const data = await response.json();
        
        if (data.ingredients && data.ingredients.length > 0) {
          await analyzeIngredients(data.ingredients);
        } else {
          hideProgress();
          alert('Could not parse ingredients. Please scan the label directly.');
        }
        
      } catch (err) {
        console.error(err);
        hideProgress();
      }
    }

    // UNIFIED ANALYSIS FUNCTION
    async function analyzeIngredients(ingredients) {
      const ocrTextElement = document.getElementById("ocrText");
      
      updateProgress(50, 'Ingredients detected! Analyzing environmental impact...');
      ocrTextElement.innerHTML += `<br>‚úÖ Ingredients: ${ingredients.join(", ")}`;

      try {
        updateProgress(60, 'Running analysis (this may take 20-30 seconds)...');
        
        // Combine standard and custom diets/allergens
        const allDiets = [...selectedDiets, ...customDiets];
        const allAllergens = [...selectedAllergens, ...customAllergens];
        
        // Build userPreferences object including custom allergens
        const preferences = { ...userAllergens };
        allAllergens.forEach(allergen => {
          preferences[allergen] = true;
        });
        
        // Fetch with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 second timeout
        
        let analysisResponse;
        try {
          analysisResponse = await fetch("https://ethica-backend-830766747753.us-central1.run.app/comprehensive-analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              ingredients: ingredients,
              userPreferences: preferences,
              dietaryPreferences: allDiets.length > 0 ? allDiets : ['none']
            }),
            signal: controller.signal
          });
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === 'AbortError') {
            throw new Error('Analysis timed out. The server took too long to respond. Please try again with a shorter ingredient list or check your internet connection.');
          } else if (!navigator.onLine) {
            throw new Error('No internet connection. Please check your network and try again.');
          } else {
            throw new Error(`Network error: ${fetchError.message}`);
          }
        }
        
        clearTimeout(timeoutId);

        if (!analysisResponse.ok) {
          const errorText = await analysisResponse.text().catch(() => 'Unknown error');
          throw new Error(`Analysis failed (${analysisResponse.status}): ${errorText}`);
        }
        
        const analysis = await analysisResponse.json();
        
        // Check for error in response
        if (analysis.error) {
          if (analysis.details && analysis.partialData) {
            // Show partial results if available
            console.warn('Incomplete analysis:', analysis.details);
            updateProgress(100, 'Complete (with warnings)');
            ocrTextElement.innerHTML += `<br>‚ö†Ô∏è Warning: Analysis incomplete - ${analysis.details.join(', ')}`;
            
            // Display what we have
            if (analysis.partialData.environmental) displayEnvironmentalImpact(analysis.partialData.environmental);
            if (analysis.partialData.allergens && analysis.partialData.dietary) {
              displayAllergenResults(analysis.partialData.allergens, analysis.partialData.dietary);
            }
            if (analysis.partialData.recommendations) displayInsights(analysis.partialData.recommendations);
            
            setTimeout(hideProgress, 1000);
            return;
          }
          throw new Error(analysis.error);
        }

        updateProgress(100, 'Complete!');
        
        // Display confidence score if available
        if (analysis.confidence) {
          displayConfidence(analysis.confidence, analysis.confidenceFactors);
        }
        
        displayEnvironmentalImpact(analysis.environmental);
        displayAllergenResults(analysis.allergens, analysis.dietary);
        displaySustainability(ingredients, analysis.environmental);
        displayInsights(analysis.recommendations);

        setTimeout(hideProgress, 1000);

      } catch (err) {
        console.error('Analysis error:', err);
        hideProgress();
        
        // User-friendly error messages
        let errorMessage = err.message;
        if (errorMessage.includes('Failed to fetch')) {
          errorMessage = 'Unable to connect to server. Please check your internet connection and try again.';
        }
        
        ocrTextElement.innerHTML += `<br><div style="background:#ffebee; padding:1rem; border-radius:0.5rem; border-left:4px solid #d32f2f; margin-top:1rem;">
          <strong>‚ùå Analysis Error</strong><br>
          <span style="color:#666;">${errorMessage}</span><br>
          <button onclick="location.reload()" style="margin-top:0.5rem; padding:0.5rem 1rem; background:#4CAF50; color:white; border:none; border-radius:0.3rem; cursor:pointer;">
            Try Again
          </button>
        </div>`;
      }
    }

    function updateProgress(percentage, message) {
      const progressBar = document.getElementById('progressBar');
      const progressContainer = document.getElementById('progressContainer');
      const loadingMessage = document.getElementById('loadingMessage');

      progressContainer.style.display = 'block';
      loadingMessage.style.display = 'block';
      
      progressBar.style.width = percentage + '%';
      progressBar.textContent = percentage + '%';
      loadingMessage.textContent = message;
    }

    function hideProgress() {
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('loadingMessage').style.display = 'none';
    }

    function displayEnvironmentalImpact(environmental) {
      if (!environmental) return;

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = `
        <div class="result-card">
          <h2>üåç Environmental Impact</h2>
          <p><strong>Total CO‚ÇÇ emissions:</strong> ${environmental.totalCO2 ? environmental.totalCO2.toFixed(2) : 0} kg CO‚ÇÇ per 100g</p>
          <p><strong>Water usage:</strong> ${environmental.waterUsage ? environmental.waterUsage.toLocaleString() : 0} L per 100g</p>
          <p><strong>Animal impact:</strong> ${environmental.animalImpact || environmental.landUse || 'Medium'}</p>
          <p><strong>Sustainability rating:</strong> ${environmental.rating || 'Unknown'}</p>
        </div>
      `;
    }

    function displayAllergenResults(allergens, dietary) {
      console.log("displayAllergenResults called with:", allergens, dietary);
      const resultDiv = document.getElementById("allergenResult");

      if (!allergens || !dietary) {
        console.warn("Missing allergen or dietary data");
        resultDiv.textContent = "‚ö†Ô∏è Allergen/dietary info unavailable";
        resultDiv.className = "";
        return;
      }

      const hasDefiniteViolations = allergens.definiteViolations && allergens.definiteViolations.length > 0;
      const hasCautionWarnings = allergens.cautionWarnings && allergens.cautionWarnings.length > 0;
      const hasDietaryViolations = dietary.violations && dietary.violations.length > 0;
      
      // Separate definite vs uncertain dietary violations
      let definiteDietaryViolations = [];
      let uncertainDietaryViolations = [];
      
      if (hasDietaryViolations) {
        dietary.violations.forEach(violation => {
          const violationLower = violation.toLowerCase();
          // Check for uncertainty keywords
          if (violationLower.includes('might') || 
              violationLower.includes('may') || 
              violationLower.includes('possibly') || 
              violationLower.includes('could') ||
              violationLower.includes('uncertain') ||
              violationLower.includes('unclear') ||
              violationLower.includes('not strictly') ||
              violationLower.includes('potentially')) {
            uncertainDietaryViolations.push(violation);
          } else {
            definiteDietaryViolations.push(violation);
          }
        });
      }

      // GREEN: Safe to eat
      if (!hasDefiniteViolations && !hasCautionWarnings && definiteDietaryViolations.length === 0 && uncertainDietaryViolations.length === 0) {
        resultDiv.innerHTML = "‚úÖ <strong>You can eat this product!</strong>";
        resultDiv.className = "green";
      }
      // RED: Definite violations - AVOID
      else if (hasDefiniteViolations || definiteDietaryViolations.length > 0) {
        let messages = [];
        
        if (hasDefiniteViolations) {
          allergens.definiteViolations.forEach(v => {
            messages.push(`<li><strong>${v.allergen}:</strong> Found in ${v.source}</li>`);
          });
        }

        if (definiteDietaryViolations.length > 0) {
          definiteDietaryViolations.forEach(v => {
            messages.push(`<li>${v}</li>`);
          });
        }

        resultDiv.innerHTML = `
          ‚õî <strong>AVOID THIS PRODUCT</strong>
          <div class="caution-details">
            <p style="margin:0.5rem 0 0.3rem 0; font-weight:600;">Reasons to avoid:</p>
            <ul style="margin:0.3rem 0 0 1.2rem; padding:0;">${messages.join("")}</ul>
          </div>
        `;
        resultDiv.className = "red";
      }
      // YELLOW: Caution warnings or uncertain dietary issues - BE CAREFUL
      else if (hasCautionWarnings || uncertainDietaryViolations.length > 0) {
        let cautionMsgs = [];
        
        if (hasCautionWarnings) {
          allergens.cautionWarnings.forEach(v => {
            cautionMsgs.push(`<li><strong>${v.allergen}:</strong> ${v.warning || v.source}</li>`);
          });
        }
        
        if (uncertainDietaryViolations.length > 0) {
          uncertainDietaryViolations.forEach(v => {
            cautionMsgs.push(`<li><strong>Dietary:</strong> ${v}</li>`);
          });
        }

        resultDiv.innerHTML = `
          ‚ö†Ô∏è <strong>BE CAUTIOUS WITH THIS PRODUCT</strong>
          <div class="caution-details">
            <p>Potential concerns:</p>
            <ul>${cautionMsgs.join("")}</ul>
            <p><em>This product may be safe, but exercise caution. Review the concerns above carefully.</em></p>
          </div>
        `;
        resultDiv.className = "yellow";
      }

      console.log("Allergen results displayed");
    }

    function displaySustainability(items, environmental) {
      if (!items || items.length === 0 || !environmental) {
        document.getElementById('sustainabilityText').textContent = 'Calculating...';
        return;
      }

      // FIXED SCALING - Based on realistic averages
      const avgCO2 = 0.8;
      const avgWater = 400;
      
      const co2Score = Math.min((environmental.totalCO2 / avgCO2) * 50, 100);
      const waterScore = Math.min((environmental.waterUsage / avgWater) * 50, 100);
      
      let animalScore = 50;
      const impactLevel = (environmental.animalImpact || environmental.landUse || "Medium").toLowerCase();
      if (impactLevel.includes("low")) animalScore = 20;
      else if (impactLevel.includes("high")) animalScore = 80;
      else animalScore = 50;

      console.log("Scaled scores:", { co2Score, waterScore, animalScore });

      setTimeout(() => {
        document.getElementById('co2Bar').style.width = `${Math.round(co2Score)}%`;
        document.getElementById('waterBar').style.width = `${Math.round(waterScore)}%`;
        document.getElementById('animalBar').style.width = `${Math.round(animalScore)}%`;
      }, 100);

      const overall = Math.round((co2Score + waterScore + animalScore) / 3);

      const text = document.getElementById('sustainabilityText');
      text.textContent = `Overall Impact Score: ${overall}%`;
      text.style.color = overall > 66 ? '#d32f2f' : overall > 40 ? '#f57f17' : '#2e7d32';

      createComparisonChart(overall);
    }

    function displayInsights(recommendations) {
      if (!recommendations) return;

      const tips = [];

      if (recommendations.insights && recommendations.insights.length > 0) {
        tips.push(...recommendations.insights.slice(0, 3));
      }

      if (recommendations.environmental && recommendations.environmental.length > 0) {
        tips.push(`üí° Consider: ${recommendations.environmental[0]}`);
      }

      if (recommendations.allergenFree && recommendations.allergenFree.length > 0) {
        tips.push(`üîÑ Alternative: ${recommendations.allergenFree[0]}`);
      }

      const container = document.getElementById('insightText');
      
      // Display Quick Insights
      if (tips.length > 0) {
        container.innerHTML = `<strong>Quick Insights</strong><ul style="margin:8px 0 0 18px;padding:0;">${tips.map(t => `<li style="margin:6px 0;">${t}</li>`).join("")}</ul>`;
      } else {
        container.innerHTML = '<strong>No additional insights available</strong>';
      }

      // Display Better Alternatives in separate section (after Quick Insights)
      if (recommendations.alternatives && recommendations.alternatives.length > 0) {
        const alternativesHTML = recommendations.alternatives.map(alt => {
          const brandText = alt.brand ? ` (${alt.brand})` : '';
          return `<div style="background:white; padding:0.8rem; border-radius:0.5rem; margin:0.5rem 0; border-left:3px solid #4CAF50; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <strong style="color:#4CAF50;">üåü ${alt.name}${brandText}</strong><br>
            <span style="font-size:0.85rem; color:#666;">${alt.reason}</span>
          </div>`;
        }).join('');
        
        container.innerHTML += `
          <div style="margin-top:1.5rem; padding-top:1rem; border-top:1px solid #e0e0e0;">
            <strong style="color:#2d5f3f; font-size:1.05rem;">Better Alternatives</strong>
            <div style="margin-top:0.5rem;">${alternativesHTML}</div>
          </div>`;
      }
    }

    function displayConfidence(confidence, factors) {
      const resultsDiv = document.getElementById("results");
      const confidenceColor = confidence >= 80 ? '#4CAF50' : confidence >= 60 ? '#FBC02D' : '#FF9800';
      const confidenceIcon = confidence >= 80 ? '‚úì' : confidence >= 60 ? '!' : '‚ö†';
      
      const factorsHTML = factors && factors.length > 0 
        ? `<ul style="margin:0.5rem 0 0 1.2rem; font-size:0.85rem; color:#666;">
            ${factors.map(f => `<li>${f}</li>`).join('')}
          </ul>`
        : '';
      
      const confidenceCard = `
        <div class="result-card" style="border-left: 4px solid ${confidenceColor};">
          <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
            <span style="font-size:1.5rem;">${confidenceIcon}</span>
            <h3 style="margin:0;">Analysis Confidence</h3>
          </div>
          <div style="background:#f5f5f5; padding:0.8rem; border-radius:0.5rem; margin-top:0.5rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
              <span style="font-weight:500;">Confidence Level:</span>
              <span style="font-size:1.3rem; font-weight:bold; color:${confidenceColor};">${confidence}%</span>
            </div>
            <div style="background:#e0e0e0; border-radius:10px; height:10px; overflow:hidden;">
              <div style="background:${confidenceColor}; height:100%; width:${confidence}%; transition:width 0.5s;"></div>
            </div>
          </div>
          ${factorsHTML}
          <p style="margin:0.5rem 0 0 0; font-size:0.85rem; color:#666; font-style:italic;">
            ${confidence >= 80 ? 'High confidence - analysis is highly reliable' : 
              confidence >= 60 ? 'Moderate confidence - analysis is generally reliable' : 
              'Lower confidence - some ingredient information may be unclear'}
          </p>
        </div>
      `;
      
      resultsDiv.innerHTML = confidenceCard + resultsDiv.innerHTML;
    }

    function createComparisonChart(userScore) {
      const ctx = document.getElementById('comparisonChart').getContext('2d');

      if (window._comparisonChart) {
        window._comparisonChart.destroy();
      }

      const baseline = 50;

      const getColor = (v) => {
        if (v <= 33) return '#66bb6a';
        if (v <= 66) return '#fbc02d';
        return '#d32f2f';
      };

      window._comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['This Product', 'Average Product'],
          datasets: [{
            label: 'Environmental Impact Score (%)',
            data: [userScore, baseline],
            backgroundColor: [getColor(userScore), '#90a4ae'],
            borderRadius: 8,
            barThickness: 36
          }]
        },
        options: {
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Impact Score: ${context.parsed.y}% (Lower is better)`;
                }
              }
            }
          },
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { stepSize: 20 },
              grid: { color: 'rgba(0,0,0,0.04)' },
              title: {
                display: true,
                text: 'Impact Score (Lower = Better)'
              }
            },
            x: {
              grid: { display: false }
            }
          },
          animation: {
            duration: 700,
            easing: 'easeOutQuart'
          }
        }
      });
    }
  </script>
</body>
</html>