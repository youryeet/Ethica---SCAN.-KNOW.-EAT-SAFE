<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <title>Ethica ‚Äì SCAN. KNOW. EAT SAFE. </title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }

    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      color: #333;
      background: linear-gradient(135deg, #e8f5e9, #e0f7fa);
      font-family: "Poppins", sans-serif;
    }

    #sustainabilityResult {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-top: 1.5rem;
      display: inline-block;
    }

    #sustainabilityText {
      font-weight: 600;
      margin-top: 12px;
      font-size: 18px;
    }

    .app-container {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
      animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      color: #4CAF50;
      margin-bottom: 0.2rem;
    }

    h3 {
      color: #555;
      margin-bottom: 1rem;
    }

    .scan-options {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    .scan-btn {
      background-color: #4f46e5;
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.8rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: 600;
    }

    .scan-btn:hover {
      background-color: #3730a3;
    }

    .scan-btn.barcode {
      background-color: #f59e0b;
    }

    .scan-btn.barcode:hover {
      background-color: #d97706;
    }

    input[type="file"] {
      display: none;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.8rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 0.5rem;
    }

    button:hover {
      background-color: #43A047;
    }

    #cameraModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    #cameraModal.active {
      display: flex;
    }

    .camera-container {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }

    #cameraFeed {
      width: 100%;
      max-width: 500px;
      border-radius: 0.5rem;
    }

    .camera-controls {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    #ocrText {
      margin-top: 15px;
      font-style: italic;
      color: #555;
    }

    #results {
      margin-top: 25px;
      text-align: center;
      background: #eaf5eb;
      border-radius: 1rem;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      word-wrap: break-word;
    }

    #results h2 {
      color: #4CAF50;
      margin-top: 0;
    }

    #results p {
      margin: 0.5rem 0;
    }

    .footer {
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #777;
      text-align: center;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-top: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .progress-bar-fill {
      height: 25px;
      background: linear-gradient(90deg, #4CAF50, #66bb6a);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
    }

    .loading-message {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
      font-style: italic;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin: 1.5rem auto;
      width: 90%;
      max-width: 450px;
      text-align: center;
      animation: fadeInUp 0.6s ease forwards;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .result-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    #allergenResult.green { 
      background: #E8F5E9; 
      color: #2E7D32; 
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }
    
    #allergenResult.yellow { 
      background: #FFF9C4; 
      color: #F57F17; 
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }
    
    #allergenResult.red { 
      background: #FFEBEE; 
      color: #C62828; 
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }

    .caution-details {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      text-align: left;
      padding-left: 1rem;
    }

    .caution-details ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .caution-details li {
      margin: 0.3rem 0;
    }

    .bar-container { margin-top: 10px; display:flex; flex-direction:column; gap:0.9rem; }
    .bar { background:#f1f8f4; border-radius:10px; overflow:hidden; height:28px; position:relative; }
    .bar span { position:absolute; left:12px; top:4px; font-size:14px; color:#2f2f2f; font-weight:600; z-index:1; }
    .bar-fill { height:100%; width:0%; transition: width 900ms cubic-bezier(.2,.8,.2,1); border-radius:10px; }

    #co2Bar { background: linear-gradient(90deg,#66bb6a,#43a047); }
    #waterBar { background: linear-gradient(90deg,#64b5f6,#1e88e5); }
    #animalBar { background: linear-gradient(90deg,#ffb74d,#fb8c00); }

    .chart-card { background:white; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin-top:12px; }

    #insightText { background:#fffefc; border-radius:8px; padding:10px 12px; box-shadow:0 3px 10px rgba(0,0,0,0.03); }

    canvas#barcodeCanvas { 
      display: none; 
      max-width: 100%; 
      border: 2px solid #4CAF50; 
      margin-top: 10px;
    }
    .barcode-mode canvas#barcodeCanvas { display: block; }
  </style>
</head>
<body>

  <div class="app-container">
    <h1>Ethica</h1>
    <h3>SCAN. KNOW. EAT SAFE ‚Äì Scan Ingredients</h3>
    <p>Choose how you want to scan your product:</p>
    
    <div class="scan-options">
      <button class="scan-btn barcode" onclick="openBarcodeScanner()">üì∑ Scan Barcode</button>
      <button class="scan-btn" onclick="openCamera()">üì∏ Take Photo</button>
      <button class="scan-btn" onclick="document.getElementById('imageInput').click()">üìÅ Upload Image</button>
    </div>

    <input type="file" id="imageInput" accept="image/*" onchange="handleFileUpload()">

    <!-- Progress Bar -->
    <div id="progressContainer" class="progress-container" style="display: none;">
      <div id="progressBar" class="progress-bar-fill">0%</div>
    </div>
    <div id="loadingMessage" class="loading-message" style="display: none;"></div>

    <p id="ocrText"></p>
    <div id="allergenResult" style="text-align:center; font-size:24px; font-weight:bold; margin-bottom:15px;"></div>

    <div id="results"></div>
    <br>

    <div id="sustainabilityResult" class="result-card">
      <h2>üå± Sustainability Breakdown</h2>

      <div class="bar-container" style="margin-top: 8px;">
        <div class="bar">
          <span>CO‚ÇÇ Impact</span>
          <div class="bar-fill" id="co2Bar"></div>
        </div>
        <div class="bar">
          <span>Water Usage</span>
          <div class="bar-fill" id="waterBar"></div>
        </div>
        <div class="bar">
          <span>Animal Impact</span>
          <div class="bar-fill" id="animalBar"></div>
        </div>
      </div>

      <div id="sustainabilityText" style="margin-top: 12px; font-weight: 700; font-size: 1.1rem;"></div>

      <div class="chart-card" style="margin-top: 18px;">
        <canvas id="comparisonChart" width="400" height="200"></canvas>
      </div>

      <div id="insightText" style="margin-top: 12px; font-size: 0.95rem; color: #333;"></div>
    </div>

    <div class="footer">Guided by Ahimsa üíö</div>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal">
    <div id="cameraContainer" class="camera-container">
      <h2 id="cameraTitle">Camera Capture</h2>
      <video id="cameraFeed" autoplay playsinline></video>
      <canvas id="barcodeCanvas"></canvas>
      <div class="camera-controls">
        <button id="captureBtn" onclick="capturePhoto()">üì∏ Capture</button>
        <button id="manualScanBtn" onclick="manualBarcodeDetect()" style="display:none; background:#2196F3;">üîç Try Detect</button>
        <button onclick="closeCamera()" style="background:#e53e3e;">‚úñ Cancel</button>
      </div>
      <p id="barcodeResult" style="margin-top:10px; color:#4CAF50; font-weight:bold;"></p>
    </div>
  </div>

  <script>
    const userAllergens = JSON.parse(localStorage.getItem('userAllergens')) || {};
    console.log("User allergens from localStorage:", userAllergens);

    let cameraStream = null;
    let barcodeInterval = null;
    let isBarcodeMode = false;

    // CAMERA FUNCTIONS
    async function openCamera() {
      isBarcodeMode = false;
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('cameraFeed');
      
      // Update UI for photo capture mode
      document.getElementById('cameraTitle').textContent = 'Camera Capture';
      document.getElementById('captureBtn').style.display = 'inline-block';
      document.getElementById('manualScanBtn').style.display = 'none';
      document.getElementById('cameraContainer').classList.remove('barcode-mode');
      document.getElementById('barcodeResult').textContent = '';
      
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        video.srcObject = cameraStream;
        modal.classList.add('active');
      } catch (err) {
        alert('Camera access denied or unavailable');
        console.error(err);
      }
    }

    function closeCamera() {
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('cameraFeed');
      
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      
      if (barcodeInterval) {
        clearInterval(barcodeInterval);
        barcodeInterval = null;
      }
      
      video.srcObject = null;
      modal.classList.remove('active');
      document.getElementById('barcodeResult').textContent = '';
    }

    async function capturePhoto() {
      const video = document.getElementById('cameraFeed');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      closeCamera();
      
      canvas.toBlob(blob => {
        processImage(blob);
      }, 'image/jpeg');
    }

    // MANUAL BARCODE DETECTION
    function manualBarcodeDetect() {
      const video = document.getElementById('cameraFeed');
      const canvas = document.getElementById('barcodeCanvas');
      const ctx = canvas.getContext('2d');
      const resultText = document.getElementById('barcodeResult');
      
      resultText.textContent = 'üîç Attempting detection...';
      
      if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        console.log('Manual scan - canvas size:', canvas.width, 'x', canvas.height);
        
        // Try multiple detection strategies
        const strategies = [
          { inversionAttempts: "attemptBoth" },
          { inversionAttempts: "dontInvert" },
          { inversionAttempts: "onlyInvert" },
          { inversionAttempts: "attemptBoth", minQuality: 0.3 },
          { inversionAttempts: "attemptBoth", minQuality: 0.1 }
        ];
        
        let code = null;
        for (let i = 0; i < strategies.length && !code; i++) {
          try {
            console.log('Trying strategy', i + 1, strategies[i]);
            code = jsQR(imageData.data, imageData.width, imageData.height, strategies[i]);
            if (code && code.data) {
              console.log('‚úÖ Success with strategy', i + 1);
              break;
            }
          } catch (err) {
            console.error('Strategy', i + 1, 'failed:', err);
          }
        }
        
        if (code && code.data) {
          console.log('‚úÖ Barcode detected:', code.data);
          resultText.textContent = `‚úÖ Found: ${code.data}`;
          resultText.style.color = '#4CAF50';
          
          if (barcodeInterval) {
            clearInterval(barcodeInterval);
            barcodeInterval = null;
          }
          
          setTimeout(() => {
            closeCamera();
            fetchProductFromBarcode(code.data);
          }, 1000);
        } else {
          resultText.textContent = '‚ùå No barcode found. Move closer & ensure barcode fills frame.';
          resultText.style.color = '#f44336';
          console.log('All detection strategies failed');
        }
      } else {
        resultText.textContent = '‚ö†Ô∏è Camera not ready. Wait a moment and try again.';
        console.log('Video not ready:', video.readyState, video.videoWidth);
      }
    }

    // BARCODE SCANNER
    async function openBarcodeScanner() {
      isBarcodeMode = true;
      console.log('openBarcodeScanner called');
      console.log('jsQR available:', typeof jsQR);
      
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('cameraFeed');
      const canvas = document.getElementById('barcodeCanvas');
      const resultText = document.getElementById('barcodeResult');
      
      // Update UI for barcode scanning mode
      document.getElementById('cameraTitle').textContent = 'Barcode Scanner';
      document.getElementById('captureBtn').style.display = 'none'; // Hide capture button
      document.getElementById('manualScanBtn').style.display = 'inline-block'; // Show manual scan button
      document.getElementById('cameraContainer').classList.add('barcode-mode'); // Show canvas
      
      if (!window.jsQR) {
        alert('Barcode scanner library not loaded. Please refresh the page.');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      
      // Clear any existing interval
      if (barcodeInterval) {
        clearInterval(barcodeInterval);
        barcodeInterval = null;
      }
      
      try {
        resultText.textContent = 'üîç Starting camera...';
        
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          } 
        });
        
        video.srcObject = cameraStream;
        await video.play();
        modal.classList.add('active');
        
        resultText.textContent = 'üîç Scanning for barcode... Hold steady!';
        
        // Give video time to start
        setTimeout(() => {
          console.log('Starting barcode scan loop, video dimensions:', video.videoWidth, 'x', video.videoHeight);
          
          let scanCount = 0;
          barcodeInterval = setInterval(() => {
            scanCount++;
            
            if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              
              if (scanCount % 5 === 0) {
                console.log('Scanning frame', scanCount, '- dimensions:', canvas.width, 'x', canvas.height);
              }
              
              try {
                // More aggressive detection with lower quality threshold
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                  inversionAttempts: "attemptBoth",
                });
                
                if (code && code.data) {
                  console.log('‚úÖ Barcode detected:', code.data);
                  clearInterval(barcodeInterval);
                  barcodeInterval = null;
                  resultText.textContent = `‚úÖ Found: ${code.data}`;
                  resultText.style.color = '#4CAF50';
                  
                  // Vibrate if available
                  if (navigator.vibrate) {
                    navigator.vibrate(200);
                  }
                  
                  setTimeout(() => {
                    closeCamera();
                    fetchProductFromBarcode(code.data);
                  }, 1500);
                } else if (scanCount % 10 === 0) {
                  // Every 10 scans, show a tip
                  resultText.textContent = 'üîç Scanning... Try moving closer or use "Try Detect" button';
                }
              } catch (err) {
                console.error('jsQR processing error:', err);
                clearInterval(barcodeInterval);
                resultText.textContent = '‚ùå Scanner error. Use "Try Detect" button or try again.';
              }
            } else {
              console.log('Video not ready yet, readyState:', video.readyState, 'dimensions:', video.videoWidth);
            }
          }, 250);
        }, 500);
        
      } catch (err) {
        alert('Camera error: ' + err.message);
        console.error('Camera access error:', err);
        resultText.textContent = '‚ùå Camera access denied';
      }
    }

    // PROCESS BARCODED INGREDIENTS (skip OCR, go straight to parsing)
    async function processBarcodedIngredients(ingredientsText) {
      updateProgress(40, 'Parsing ingredients from barcode...');
      
      try {
        // Clean and parse ingredients text
        const cleanedText = ingredientsText.toLowerCase().trim();
        
        // Split by common delimiters
        const ingredients = cleanedText
          .split(/[,;]+/)
          .map(ing => ing.trim())
          .filter(ing => ing.length > 2)
          .map(ing => {
            // Remove percentages and extra info in parentheses
            return ing.replace(/\([^)]*\)/g, '').replace(/\d+%/g, '').trim();
          })
          .filter(ing => ing.length > 0);
        
        if (ingredients.length > 0) {
          await analyzeIngredients(ingredients);
        } else {
          hideProgress();
          alert('Could not parse ingredients from barcode. Please scan the label directly.');
        }
        
      } catch (err) {
        console.error('Ingredient parsing error:', err);
        hideProgress();
        alert('Error parsing ingredients. Please try scanning the label directly.');
      }
    }

    // BARCODE LOOKUP
    async function fetchProductFromBarcode(barcode) {
      updateProgress(20, 'Looking up product from barcode...');
      
      try {
        const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
        const data = await response.json();
        
        if (data.status === 1 && data.product) {
          const product = data.product;
          const ingredientsText = product.ingredients_text || product.ingredients_text_en || '';
          
          if (!ingredientsText) {
            alert('Product found, but no ingredients listed. Please scan the ingredients label directly.');
            hideProgress();
            return;
          }
          
          document.getElementById('ocrText').innerHTML = `‚úÖ Product: ${product.product_name || 'Unknown'}<br>Brand: ${product.brands || 'Unknown'}`;
          
          // Parse ingredients directly (skip OCR since we have text)
          processBarcodedIngredients(ingredientsText);
          
        } else {
          alert('Product not found in database. Please scan the ingredients label directly.');
          hideProgress();
        }
      } catch (err) {
        console.error('Barcode lookup error:', err);
        alert('Failed to look up barcode. Please try scanning the ingredients label.');
        hideProgress();
      }
    }

    // FILE UPLOAD HANDLER
    function handleFileUpload() {
      const file = document.getElementById('imageInput').files[0];
      if (file) {
        processImage(file);
      }
    }

    // UNIFIED IMAGE PROCESSING
    async function processImage(imageFile) {
      const ocrTextElement = document.getElementById("ocrText");
      ocrTextElement.innerHTML = '';
      updateProgress(10, 'Uploading image...');

      try {
        const reader = new FileReader();
        const base64Image = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result.split(",")[1]);
          reader.onerror = reject;
          reader.readAsDataURL(imageFile);
        });

        updateProgress(20, 'Extracting ingredients from image...');
        
        const ingredientsResponse = await fetch("https://ethica-backend-830766747753.us-central1.run.app/extract-ingredients", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageBase64: base64Image })
        });

        if (!ingredientsResponse.ok) throw new Error(`Server returned ${ingredientsResponse.status}`);
        
        const ingredientsData = await ingredientsResponse.json();
        
        if (!ingredientsData.ingredients || ingredientsData.ingredients.length === 0) {
          hideProgress();
          ocrTextElement.innerText = "‚úÖ OCR succeeded, but no known ingredients were detected.";
          return;
        }

        const ingredients = ingredientsData.ingredients;
        await analyzeIngredients(ingredients);

      } catch(err) {
        console.error("‚ùå Error:", err);
        hideProgress();
        ocrTextElement.innerHTML = `‚ùå Error: ${err.message}`;
      }
    }

    // PROCESS INGREDIENTS TEXT (from barcode lookup)
    async function processIngredientsText(text) {
      updateProgress(30, 'Processing ingredients...');
      
      try {
        // Send to backend to parse ingredients
        const response = await fetch("https://ethica-backend-830766747753.us-central1.run.app/extract-ingredients", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            imageBase64: btoa(text)
          })
        });

        const data = await response.json();
        
        if (data.ingredients && data.ingredients.length > 0) {
          await analyzeIngredients(data.ingredients);
        } else {
          hideProgress();
          alert('Could not parse ingredients. Please scan the label directly.');
        }
        
      } catch (err) {
        console.error(err);
        hideProgress();
      }
    }

    // UNIFIED ANALYSIS FUNCTION
    async function analyzeIngredients(ingredients) {
      const ocrTextElement = document.getElementById("ocrText");
      
      updateProgress(50, 'Ingredients detected! Analyzing environmental impact...');
      ocrTextElement.innerHTML += `<br>‚úÖ Ingredients: ${ingredients.join(", ")}`;

      try {
        updateProgress(60, 'Running analysis (this may take 20-30 seconds)...');
        
        const analysisResponse = await fetch("https://ethica-backend-830766747753.us-central1.run.app/comprehensive-analysis", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            ingredients: ingredients,
            userPreferences: userAllergens
          })
        });

        if (!analysisResponse.ok) throw new Error(`Analysis failed`);
        
        const analysis = await analysisResponse.json();
        
        if (analysis.error) throw new Error(analysis.error);

        updateProgress(100, 'Complete!');
        
        displayEnvironmentalImpact(analysis.environmental);
        displayAllergenResults(analysis.allergens, analysis.dietary);
        displaySustainability(ingredients, analysis.environmental);
        displayInsights(analysis.recommendations);

        setTimeout(hideProgress, 1000);

      } catch (err) {
        console.error(err);
        hideProgress();
        ocrTextElement.innerHTML += `<br>‚ùå Analysis error: ${err.message}`;
      }
    }

    function updateProgress(percentage, message) {
      const progressBar = document.getElementById('progressBar');
      const progressContainer = document.getElementById('progressContainer');
      const loadingMessage = document.getElementById('loadingMessage');

      progressContainer.style.display = 'block';
      loadingMessage.style.display = 'block';
      
      progressBar.style.width = percentage + '%';
      progressBar.textContent = percentage + '%';
      loadingMessage.textContent = message;
    }

    function hideProgress() {
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('loadingMessage').style.display = 'none';
    }

    function displayEnvironmentalImpact(environmental) {
      if (!environmental) return;

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = `
        <div class="result-card">
          <h2>üåç Environmental Impact</h2>
          <p><strong>Total CO‚ÇÇ emissions:</strong> ${environmental.totalCO2 ? environmental.totalCO2.toFixed(2) : 0} kg CO‚ÇÇ per 100g</p>
          <p><strong>Water usage:</strong> ${environmental.waterUsage ? environmental.waterUsage.toLocaleString() : 0} L per 100g</p>
          <p><strong>Animal impact:</strong> ${environmental.animalImpact || environmental.landUse || 'Medium'}</p>
          <p><strong>Sustainability rating:</strong> ${environmental.rating || 'Unknown'}</p>
        </div>
      `;
    }

    function displayAllergenResults(allergens, dietary) {
      console.log("displayAllergenResults called with:", allergens, dietary);
      const resultDiv = document.getElementById("allergenResult");

      if (!allergens || !dietary) {
        console.warn("Missing allergen or dietary data");
        resultDiv.textContent = "‚ö†Ô∏è Allergen/dietary info unavailable";
        resultDiv.className = "";
        return;
      }

      const hasDefiniteViolations = allergens.definiteViolations && allergens.definiteViolations.length > 0;
      const hasCautionWarnings = allergens.cautionWarnings && allergens.cautionWarnings.length > 0;
      const hasDietaryViolations = dietary.violations && dietary.violations.length > 0;

      // GREEN: Safe to eat
      if (!hasDefiniteViolations && !hasCautionWarnings && !hasDietaryViolations) {
        resultDiv.innerHTML = "‚úÖ <strong>You can eat this product!</strong>";
        resultDiv.className = "green";
      }
      // RED: Definite violations - AVOID
      else if (hasDefiniteViolations || hasDietaryViolations) {
        let messages = [];
        
        if (hasDefiniteViolations) {
          const allergenMsgs = allergens.definiteViolations.map(v => 
            `<strong>${v.allergen}</strong> (found in: ${v.source})`
          );
          messages.push(`<strong>Allergens:</strong> ${allergenMsgs.join(", ")}`);
        }

        if (hasDietaryViolations) {
          messages.push(`<strong>Dietary:</strong> ${dietary.violations.join(", ")}`);
        }

        resultDiv.innerHTML = `
          ‚õî <strong>AVOID THIS PRODUCT</strong>
          <div class="caution-details">
            ${messages.join("<br>")}
          </div>
        `;
        resultDiv.className = "red";
      }
      // YELLOW: Caution warnings - BE CAREFUL
      else if (hasCautionWarnings) {
        const cautionMsgs = allergens.cautionWarnings.map(v => 
          `<li><strong>${v.allergen}:</strong> ${v.warning || v.source}</li>`
        );

        resultDiv.innerHTML = `
          ‚ö†Ô∏è <strong>BE CAUTIOUS WITH THIS PRODUCT</strong>
          <div class="caution-details">
            <p>Potential concerns:</p>
            <ul>${cautionMsgs.join("")}</ul>
            <p><em>This product may be safe, but exercise caution if you have severe allergies.</em></p>
          </div>
        `;
        resultDiv.className = "yellow";
      }

      console.log("Allergen results displayed");
    }

    function displaySustainability(items, environmental) {
      if (!items || items.length === 0 || !environmental) {
        document.getElementById('sustainabilityText').textContent = 'Calculating...';
        return;
      }

      // FIXED SCALING - Based on realistic averages
      const avgCO2 = 0.8;
      const avgWater = 400;
      
      const co2Score = Math.min((environmental.totalCO2 / avgCO2) * 50, 100);
      const waterScore = Math.min((environmental.waterUsage / avgWater) * 50, 100);
      
      let animalScore = 50;
      const impactLevel = (environmental.animalImpact || environmental.landUse || "Medium").toLowerCase();
      if (impactLevel.includes("low")) animalScore = 20;
      else if (impactLevel.includes("high")) animalScore = 80;
      else animalScore = 50;

      console.log("Scaled scores:", { co2Score, waterScore, animalScore });

      setTimeout(() => {
        document.getElementById('co2Bar').style.width = `${Math.round(co2Score)}%`;
        document.getElementById('waterBar').style.width = `${Math.round(waterScore)}%`;
        document.getElementById('animalBar').style.width = `${Math.round(animalScore)}%`;
      }, 100);

      const overall = Math.round((co2Score + waterScore + animalScore) / 3);

      const text = document.getElementById('sustainabilityText');
      text.textContent = `Overall Impact Score: ${overall}%`;
      text.style.color = overall > 66 ? '#d32f2f' : overall > 40 ? '#f57f17' : '#2e7d32';

      createComparisonChart(overall);
    }

    function displayInsights(recommendations) {
      if (!recommendations) return;

      const tips = [];

      if (recommendations.insights && recommendations.insights.length > 0) {
        tips.push(...recommendations.insights.slice(0, 2));
      }

      if (recommendations.environmental && recommendations.environmental.length > 0) {
        tips.push(`üí° Consider: ${recommendations.environmental[0]}`);
      }

      if (recommendations.allergenFree && recommendations.allergenFree.length > 0) {
        tips.push(`üîÑ Alternative: ${recommendations.allergenFree[0]}`);
      }

      const finalTips = tips.slice(0, 3);
      const container = document.getElementById('insightText');
      
      if (finalTips.length > 0) {
        container.innerHTML = `<strong>Quick Insights</strong><ul style="margin:8px 0 0 18px;padding:0;">${finalTips.map(t => `<li style="margin:6px 0;">${t}</li>`).join("")}</ul>`;
      } else {
        container.innerHTML = '<strong>No additional insights available</strong>';
      }
    }

    function createComparisonChart(userScore) {
      const ctx = document.getElementById('comparisonChart').getContext('2d');

      if (window._comparisonChart) {
        window._comparisonChart.destroy();
      }

      const baseline = 50;

      const getColor = (v) => {
        if (v <= 33) return '#66bb6a';
        if (v <= 66) return '#fbc02d';
        return '#d32f2f';
      };

      window._comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['This Product', 'Average Product'],
          datasets: [{
            label: 'Environmental Impact Score (%)',
            data: [userScore, baseline],
            backgroundColor: [getColor(userScore), '#90a4ae'],
            borderRadius: 8,
            barThickness: 36
          }]
        },
        options: {
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Impact Score: ${context.parsed.y}% (Lower is better)`;
                }
              }
            }
          },
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { stepSize: 20 },
              grid: { color: 'rgba(0,0,0,0.04)' },
              title: {
                display: true,
                text: 'Impact Score (Lower = Better)'
              }
            },
            x: {
              grid: { display: false }
            }
          },
          animation: {
            duration: 700,
            easing: 'easeOutQuart'
          }
        }
      });
    }
  </script>
</body>
</html>